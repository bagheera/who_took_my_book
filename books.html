<html>
<head>
    <title>who took my book</title>
    <link type="text/css" rel="stylesheet" href="/stylesheets/pres.css"/>
    <script type="text/javascript" src="/suggest/autosuggest_v2.1.3/js/bsn.AutoSuggest_2.1.3.js"
            charset="utf-8"></script>
    <link rel="stylesheet" href="/suggest/autosuggest_v2.1.3/css/autosuggest_inquisitor.css" type="text/css"/>
    <script type="text/javascript" src="/jslib/jq.js"></script>
    <script>
    	var book_data = null;
    	var show = "all";
		function del_link(book){
			return '<a href="/delete/' + book.key + '">delete</a>';
		}
		function lend_link(book){
			return '<a href="/lend/' + book.key + '">lend</a>';
		}
		function return_link(book){
			return '<a href="/return/' + book.key + '">return</a>';
		}
		function available(book){
			return (book.borrowed_by == "None");
		}
		function borrow_link(book){
			return available(book) ? 
						'<a href="/borrow/' + book.key + '">borrow</a>' :
						"";
		}
		function borrower(book) {
			return (available(book) ? "" : book.borrowed_by);
		}
		function not_to_be_shown(book){
			if (show == "all") return false;
			if (show == "tech" && book.is_tech) return false;
			if (show == "non-tech" && (!book.is_tech)) return false;
			return true; 
		}
		function othersbookrow(i){
			if (not_to_be_shown(this)) return;
			$("#othersbooks_table").append("<tr><td>" + this.owner +
													"</td><td>" + this.title +
													" by " + this.author +
													"</td><td>"+borrower(this) +
													"</td><td class='action'>"+borrow_link(this) +
													"</td></tr>");
	    }
		function mybookrow(i){
			if (not_to_be_shown(this)) return;
			$("#mybooks_table").append(
													"<tr><td class>" + del_link(this) +
													"</td><td>" + this.title +
													" by " + this.author +
													"</td><td>"+ borrower(this) +
													"</td><td class='action'>" + lend_link(this) +
													"</td></tr>");
	    }
		function borrowedBookrow(i){
			if (not_to_be_shown(this)) return;
			$("#borrowed_books_table").append(
													"<tr><td>" + this.owner +
													"</td><td>" + this.title +
													" by "+ this.author +
													"</td><td></td><td class='action'>" + return_link(this) +
													"</td></tr>");
	    }
	    function showgif(){
	    		
	    		//script from: http://www.sitepoint.com/forums/showthread.php?t=581377
	    		//loading.gif from http://www.ajaxload.info/
	    		
			     $('<div id="overlay"/>').css({
			        position: 'fixed',
			        top: 0,
			        left: 0,
			        width: '100%',
			        height: $(window).height() + 'px',
			        background: 'white url(/s/loading.gif) no-repeat center'
				    }).appendTo('body');
	    }
	    
	    function lent_count(list){
     		count = 0;
	    	if (list){
	    		$.each(list,
	    			function(i){
	    				if (!available(this)) count ++;
	    			}
	    			);
	    	}
    		return count;
	    }
	    function renderBooks(data) {
	    	book_data = data;
	    	$("#borrowed_books_table").empty();
	    	$("#mybooks_table").empty();
	    	$("#othersbooks_table").empty();
	    	$("#book_count").empty();
	    	own_count = data.mybooks ? data.mybooks.length : 0
	    	borrow_count = data.borrowedBooks ? data.borrowedBooks.length : 0
	    	$("#book_count").append("Overall summary of your books: " + own_count + " owned, " + lent_count(data.mybooks) + " lent, "+ borrow_count+ " borrowed.");
		    if (data.mybooks){
		    	$("#mybooks_table").append('<tr><th class="colone"></th><th class="coltwo">Book</th><th class="colthree">Lent to</th><th class="colfour"></th></tr>');
		    	$.each(data.mybooks, mybookrow);
		    }else{
		    	$("#mybooks_table").append('<tr><td>Nothing yet. Use the lookup box above to start adding to your collection.</td></tr>');
		    }
		    if (data.borrowedBooks){
		    	$("#borrowed_books_table").append('<tr><th class="colone">From</th><th class="coltwo">Book</th><th class="colthree"></th><th class="colfour"></th></tr>');
		    	$.each(data.borrowedBooks, borrowedBookrow);
		    }else{
		    	$("#borrowed_books_table").append('<tr><td>Nothing yet. Don&apos;t you want to read any of the books below?</td></tr>');
		    }
		    if (data.others.length > 0) {
		    	$("#othersbooks_table").append('<tr><th class="colone">Owner</th><th class="coltwo">Book</th><th class="colthree">Lent to</th><th class="colfour"></th></tr>');
		    	$.each(data.others, othersbookrow);
		    }else{
		    	$("#othersbooks_table").append('<tr><td>Nothing here? That can&apos;t be true!</td></tr>');
		    }
		    $('#overlay').hide();
		}
		
		function show_tech_only(){
			show = "tech";
			renderBooks(book_data);
		}
		function show_non_tech_only(){
			show = "non-tech";
			renderBooks(book_data);
		}
		function show_all(){
			show = "all";
			renderBooks(book_data);
		}
		function dojson(){
	    	showgif();
			$.getJSON("/mybooksj", renderBooks);
			$("#tech_only").click(show_tech_only);        
			$("#non_tech_only").click(show_non_tech_only);        
			$("#show_all").click(show_all);        
		}
        $(document).ready(dojson);
    </script>
</head>
<body>
<div id="page">
    <div id="dataentry">
        <span id="about"><a href="/s/about.html">About</a></span>
        <span id="import"><a href="/s/import.html">Import</a></span>
        <span id="lo"><a href="{{ url }}">{{ url_linktext }}</a></span>
        <p id="letterhead">
	        <strong>Who took my book?</strong><br/>
    	    <em>Never lose your book again</em></p>
    		<form action="/addBook" method="post">
			    <div id="quick">
			        <strong>Quick data entry</strong><br/>
			        <label>Lookup amazon:</label>
			        <input type="text" id="suggestbox" value="" title="Type a word of author or title and pause for auto suggest"/>
			        <!--<input type="submit" value="Add Book"/>-->
			    </div>
			    <div id="manual">
			        <strong>Manual entry</strong><br/>
			        <label>Title:</label><input type="text" name="book_title" id="book_title"/>
			        <label>Author:</label><input type="text" name="book_author" id="book_author"/>
			        <input type="hidden" name="book_asin" id="book_asin"/>
			        <input type="submit" value="Add Book"/>
			    </div>
	    </form>
    </div>
    
    <div id="bookshelf">
    	<p id="show_options"><a id="tech_only" href="#">Show tech books only</a>  <a id="non_tech_only" href="#">Show non-tech books only</a>  <a id="show_all" href="#">Show all</a></p>
	    <h3>Hi {{ current_user.googleUser }}</h3>
	    <p id="book_count"></p>
    	<h3>Books you own</h3>
    	<table id="mybooks_table"></table>
    	<h3>Books you have borrowed</h3>
    	<table id="borrowed_books_table"></table>
    	<h3>Other Books</h3>
    	<table id="othersbooks_table"></table>
    </div>
    <p>
    <em>note: the actions lend, borrow, return are merely meant to track offline book transactions.</em>
    </p>
</div>
<script type="text/javascript">
    var options = {
        script:"/lookup_amz?",
        varname:"fragment",
        json:true,
        shownoresults:false,
        maxresults:6,
        callback: function (obj) {
            document.getElementById('book_title').value = obj.value;
            document.getElementById('book_author').value = obj.info;
            document.getElementById('book_asin').value = obj.id;
        }
    };
    var as_json = new bsn.AutoSuggest('suggestbox', options);
</script>
</body>
</html>
