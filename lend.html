<html>
    <head>
        <title>who took my book</title>
		<link rel="icon" type="image/vnd.microsoft.icon" href="/s/wtmb.ico" />
        <link type="text/css" rel="stylesheet" href="/stylesheets/pres.css" />
        <script type="text/javascript" src="/jslib/jq.js">
        </script>
        <script type="text/javascript">
           	function create_lease_error(xhr, desc, exceptionobj){
                alert(xhr.statusText);
            }
			
			function create_lease_success(whatever){
				window.location.replace("/mybooks");
			}
            
			function create_lease(book_id, borrower_id, new_user_name, new_user_email){
				payload = {};
				payload['book_id'] = book_id;
				if(borrower_id) payload['lend_to'] = borrower_id;
				if(new_user_name) payload['new_user'] = new_user_name;
				if(new_user_email) payload['new_user_email'] = new_user_email;
			    $.ajax({
			        url: "/lendTo",
			        type: "POST",
			        data: payload,
					success: create_lease_success,
			        error: create_lease_error
			    });					
			}

            $(document).ready(
				function(){
	                $('#new_user_dialog_text').hide();
					
					$("#choose_borrower").change(
						function(){
							choice = $("#choose_borrower option:selected").val();
							if(choice == "outsider"){
		                    	$('#new_user_dialog_text').show();
		                    	$('#new_user_text').focus();
								return false;								
							}
							if(choice == "dummy") return false;
							create_lease($("#book_id").val(), choice, null);
						});
					
					$('#new_user_submit').click(
						function(){
								create_lease($("#book_id").val(), null, $("#new_user_text").val(), $("#new_user_email").val());
	            		});
               });
        </script>
    </head>
    <body>
        <div id="page">
            <input type="hidden" id="book_id" value="{{ book.key }}">
            </input>
            <div id="userlist">
                <H4>Lend Book:</H4>
                <p>
                    {{book.summary}}
                </p>
                <strong>to: </strong>
                <select id="choose_borrower">
                    <option value="dummy">choose a user...</option>
                    {% for user in members %}<option value="{{ user.0 }}">{{ user.1 }}</option>
                    {% endfor %}<option value="outsider" class="stand_out">someone else?...</option>
                </select>
				<br><small>Select option 'someone else' at the end if the borrower is not registerd with the app</small>
                <div id="new_user_dialog_text">
                	<br>
                    <label for="new_user_text">Borrower name (required):</label> 
					<input type="text" id="new_user_text" size="10"></input>
					<br>
                    <label for="new_user_email">Borrower email (optional):</label>
					<input type="text" id="new_user_email" size="20"></input>
					<small>To inform about this book and to invite to use <q>who took my book</q></small> 
					<br><button id="new_user_submit">submit</button>
                </div>
            </div>
        </div>
    </body>
</html>